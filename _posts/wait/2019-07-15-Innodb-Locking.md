---
layout: post
title: InnoDB Locking
tags: [MySQL, InnoDB, Lock]
---
## InnoDB Locking

InnoDB 에서 사용하는 락의 종류는 아래와 같다.

* 공유와 배타적 락
* 인텐션 락
* 레코드 락
* 갭락
* 넥스트-키 락
* 삽입 인텐션 락
* AUTO-INC 락
* Predicate Locks for Spatial Indexes

## 공유와 독점 락

InnoDB 는 공유락과 독점락을 구현한다.

* 공유 락 : 로우를 읽는 것에 락을 건다.
* 독점 락 : 로우를 업데이트 하거나 삭제는 것에 락을 건다.

만약 트랜잭션 T1 이 어떤 로우 r 에 공유 락을 건다면, 그 로우에 대한 다른 트랜잭션 T2 의 요청은 다음과 같이 처리된다.

* T2 의 공유 락 요청은 즉시 승인된다. 그 결과, T1 과 T2 모두 r 에 공유락을 건다.
* T2 의 독점 락 요청은 즉시 승인되지 않는다.

만약 트랜잭션 T1 이 로우 r 에 독점 락을 건다면 다른 트랜잭션 T2 의 두 어떤 종류의 락도 즉시 승인되지 않는다. T2 는 T1 이 로우 r 에 대한 락을 해제할 때까지 대기해야 한다.

## 인텐션 락

InnoDB 는 로우락와 테이블락의 공존을 허용하는 다중 입도 락킹(multi granularity locking)을 지원한다. 예를 들어  LOCK TABLES ... WRITE 같은 구문은 특정 테이블에 독점 락을 건다. InnoDB 는 다중 입도 레벨로 락킹을 실용화하기 위해서 인텐션 락을 사용한다. 인텐션 락은 트랜잭션이 테이블의 한 행에 대해 나중에 필요로하는 락의 유형(공유 또는 독점)을 나타내는 테이블 레벨 락이다.

* 인텐션 공유 락(IS)은 트랜잭션이 테이블의 개별 행에 공유 락을 설정하려는 것을 가리킨다.
* 인텐션 독점 락(IX)은 트랜잭션이 테이블의 개별 행에 독점 락을 설정하려는 것을 가리킨다.

예를 들어, SELECT ... FOR SHARE 는 인텐션 공유 락(IS)을 설정한다. 그리고 SELECT ... FOR UPDATE  는 인텐션 독점 락(IX)을 설정한다.

인텐션 락 프로토콜은 다음을 따른다.

* 트랜잭션이 테이블의 한 행에 대해 공유락을 획득할 수 있기 전에, 그 테이블에 IS 락이나 그보다 강한 것을 먼저 획득해야 한다.
* 트랜잭션이 테이블의 한 행에 대해 독점락을 획득할 수 있기 전에, 그 테이블에 IX 를 먼저 획득해야 한다.

테이블 레벨 락 유형 호환성은 다음의 테이블로 요약할 수 있다.

|      | X    | IX   | S    | IS   |
| ---- | ---- | ---- | ---- | ---- |
| X    | 충돌 | 충돌 | 충돌 | 충돌 |
| IX   | 충돌 | 호환 | 충돌 | 호환 |
| S    | 충돌 | 충돌 | 호환 | 호환 |
| IS    | 충돌 | 호환 | 호환 | 호환 |

락은 존재하는 락과 호환된다면 트랜잭션 요청이 승인되지만 충돌하면 승인되지 않는다. 트랜잭션은 존재하는 락이 해제될 때까지 대기한다. 락 요청이 존재하는 락과 충돌하고 데드락의 이유로 승인될 수 없다면 에러가 발생한다.

인텐션락은 전체 테이블 요청(예를 들어 LOCK TABLES ... WRITE)을 제외하고 어떤 다른 것도 블록하지 않는다. 인텐션락의 주 목적은 **누군가가 행을 락킹하고 있음을 또는 그 테이블의 어떤 행에 락을 걸 것이라는 것**을 보여주는 것이다.

인텐션락에 대한 트랜잭션 데이터는 

## 참고

* [InnoDB Locking](https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html)
* [MySQL InnoDB lock & deadlock 이해하기](https://www.letmecompile.com/mysql-innodb-lock-deadlock/)
* [잠금에 관한 고찰(1) - 잠금(Lock) 매커니즘에 대하여](https://kuaaan.tistory.com/97)